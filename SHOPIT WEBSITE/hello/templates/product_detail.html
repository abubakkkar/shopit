{% extends "base.html" %}

{% block title %}Product - ShopIt{% endblock %}

{% block body %}
<div style="max-width: 1200px; margin: 40px auto; padding: 20px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <!-- Product Images -->
        <div>
            {% if product.image %}
            <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" style="width: 100%; border-radius: 8px; margin-bottom: 15px;">
            {% else %}
            <div style="width: 100%; height: 400px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 8px;">No Image</div>
            {% endif %}
            
            {% if images %}
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                {% for img in images %}
                <img src="{{ img.image.url }}" alt="Product" style="width: 100%; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer;" onclick="document.getElementById('mainImage').src='{{ img.image.url }}'">
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Product Details -->
        <div>
            <h1>{{ product.name }}</h1>
            <p style="color: #666; margin: 10px 0;">{{ product.category.name }}</p>
            
            <!-- Rating -->
            {% if avg_rating %}
            <div style="margin: 15px 0;">
                <span style="font-size: 18px; color: #ffc107;">‚òÖ</span>
                <span>{{ avg_rating|floatformat:1 }} / 5 ({{ reviews.count }} reviews)</span>
            </div>
            {% endif %}

            <!-- Price & Stock -->
            <p style="font-size: 28px; color: #28a745; font-weight: bold; margin: 20px 0;">Rs. {{ product.price }}</p>
            
            <p style="margin-bottom: 15px;">
                {% if product.stock > 0 %}
                <span style="color: #28a745; font-weight: bold;">‚úì In Stock ({{ product.stock }} available)</span>
                {% else %}
                <span style="color: #dc3545; font-weight: bold;">Out of Stock</span>
                {% endif %}
            </p>

            <p style="color: #666; line-height: 1.6; margin: 20px 0;">{{ product.description }}</p>

            <!-- Variants -->
            {% if variants %}
            <div style="margin: 20px 0;">
                <h4>Options:</h4>
                {% for variant in variants %}
                <p>
                    <label style="margin-right: 15px;">
                        <input type="radio" name="variant" value="{{ variant.id }}"> {{ variant.variant_value }}
                        {% if variant.extra_price > 0 %}(+Rs. {{ variant.extra_price }}){% endif %}
                    </label>
                </p>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Quantity -->
            <div style="margin: 20px 0;">
                <label for="qty">Quantity:</label>
                <input type="number" id="qty" name="quantity" min="1" max="{{ product.stock }}" value="1" style="width: 70px; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
            </div>

            <!-- Action Buttons -->
            <button onclick="addToCart({{ product.id }})" {% if product.stock == 0 %}disabled{% endif %} style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; width: 100%; margin-bottom: 10px; {% if product.stock == 0 %}opacity: 0.5;{% endif %}">
                üõí Add to Cart
            </button>
            
            <button onclick="addToWishlist({{ product.id }})" style="padding: 12px 30px; background: #ffc107; color: black; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; width: 100%; margin-bottom: 20px;">
                ‚ù§Ô∏è Add to Wishlist
            </button>

            <div style="background: #f9f9f9; padding: 15px; border-radius: 5px;">
                <p><strong>üöö Delivery:</strong> Free shipping on orders over Rs. 1000</p>
                <p><strong>üîÑ Returns:</strong> 7-day return policy</p>
                <p><strong>üõ°Ô∏è Warranty:</strong> As per manufacturer</p>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div style="margin-top: 50px; border-top: 2px solid #ddd; padding-top: 30px;">
        <h3>Reviews ({{ reviews.count }})</h3>

        {% if user.is_authenticated %}
        <!-- Add Review Form -->
        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h4>Leave a Review</h4>
            <form method="POST">
                {% csrf_token %}
                <div style="margin-bottom: 15px;">
                    <label for="rating">Rating:</label>
                    <select name="rating" required style="padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                        <option value="">Select Rating</option>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê Average</option>
                        <option value="2">‚≠ê‚≠ê Poor</option>
                        <option value="1">‚≠ê Terrible</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="comment">Comment:</label>
                    <textarea name="comment" rows="4" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
                </div>
                <button type="submit" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Post Review</button>
            </form>
        </div>
        {% else %}
        <p><a href="{% url 'login' %}">Login</a> to leave a review</p>
        {% endif %}

        <!-- Reviews List -->
        {% for review in reviews %}
        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between;">
                <strong>{{ review.user.username }}</strong>
                <small style="color: #999;">{{ review.created_at|date:"d M Y" }}</small>
            </div>
            <div style="color: #ffc107; margin: 5px 0;">
                {% for i in "12345" %}
                    {% if i|stringformat:"d"|add:0 <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                {% endfor %}
            </div>
            <p style="color: #666;">{{ review.comment }}</p>
        </div>
        {% empty %}
        <p>No reviews yet. Be the first to review!</p>
        {% endfor %}
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div style="margin-top: 50px; border-top: 2px solid #ddd; padding-top: 30px;">
        <h3>Related Products</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
            {% for related in related_products %}
            <div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; text-align: center;">
                {% if related.image %}
                <img src="{{ related.image.url }}" alt="{{ related.name }}" style="width: 100%; height: 200px; object-fit: cover;">
                {% else %}
                <div style="width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">No Image</div>
                {% endif %}
                <div style="padding: 15px;">
                    <h4 style="margin: 10px 0;">{{ related.name }}</h4>
                    <p style="font-size: 16px; color: #28a745; font-weight: bold;">Rs. {{ related.price }}</p>
                    <a href="{% url 'product_detail' related.id %}" style="padding: 8px 15px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; display: inline-block;">View</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script src="{% static 'js/cart.js' %}"></script>
<script>
function addToWishlist(productId) {
    fetch(`/add-to-wishlist/${productId}/`)
        .then(r => r.json())
        .then(data => {
            alert(data.status === 'added' ? 'Added to wishlist!' : 'Removed from wishlist');
        });
}
</script>
{% endblock %}
